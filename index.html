<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ç«¹åŒ—è³‡æºå¤©ç§¤</title>
<style>
  /* --- V16.5 æ¨£å¼è¡¨ --- */
  * { box-sizing: border-box; }
  body { 
    font-family: "Helvetica Neue", Helvetica, "Microsoft JhengHei", Arial, sans-serif; 
    background-color: #f0f2f5; margin: 0; padding: 0; min-height: 100vh;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
  }
  .container { width: 100%; max-width: 450px; padding: 20px; }
  .card { 
    background: #fff; border-radius: 16px; padding: 25px; width: 100%; 
    box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-top: 6px solid #2c3e50; 
  }
  
  h2 { color: #2c3e50; margin: 0 0 8px 0; font-size: 24px; text-align: center; letter-spacing: 1px; }
  .sub-header { font-size: 14px; color: #7f8c8d; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; text-align: center; line-height: 1.5; }
  
  .live-tag { display: block; background: #e8f5e9; color: #2e7d32; padding: 8px; border-radius: 6px; font-size: 14px; font-weight: bold; margin-bottom: 20px; border: 1px solid #c8e6c9; text-align: center; }
  
  .btn { background: #2c3e50; color: white; border: none; padding: 16px 0; font-size: 18px; border-radius: 12px; cursor: pointer; width: 100%; font-weight: bold; transition: 0.2s; box-shadow: 0 4px 12px rgba(44, 62, 80, 0.3); }
  .btn:active { transform: scale(0.98); }
  
  .result-area { display: none; margin-top: 25px; animation: fadeIn 0.5s; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  .metric-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #eee; }
  .metric-label { font-size: 13px; color: #555; flex: 1; }
  .metric-val { font-size: 20px; font-weight: bold; color: #2c3e50; text-align: right; }
  .nav-link { display: inline-flex; align-items: center; color: #2980b9; text-decoration: none; font-weight: bold; font-size: 13px; margin-top: 4px; padding: 4px 8px; background: #eef6fb; border-radius: 4px; }
  
  /* åœŸåœ°å…¬ç­†è¨˜å€æ¨£å¼ */
  .chief-msg-box { margin-top: 20px; background: #fff5f8; padding: 15px; border-radius: 10px; border-left: 5px solid #e91e63; display: none; }
  .chief-title { font-size: 14px; font-weight: bold; color: #e91e63; margin-bottom: 8px; display: flex; align-items: center; }
  .chief-content { font-size: 15px; color: #333; line-height: 1.6; }

  .analysis-box { margin-top: 20px; padding: 20px; border-radius: 10px; }
  .role-badge { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-bottom: 10px; }
  .role-guardian { background: #fff8e1; color: #856404; }
  .role-noble { background: #d1ecf1; color: #0c5460; }
  .role-citizen { background: #e2e3e5; color: #383d41; }
  
  .action-group { margin-top: 25px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .btn-full { grid-column: span 2; padding: 12px; border-radius: 8px; border: none; color: white; font-weight: bold; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center;}
  .btn-share { background: #06c755; }
  .btn-group { background: #3498db; }
  .btn-icon { margin-right: 8px; font-size: 18px; }

  .entry-box { margin-top: 25px; border-top: 1px dashed #ccc; padding-top: 20px; text-align: center; }
  .entry-btn { 
    display: block; width: 100%; background: #fff; color: #2c3e50; 
    border: 2px solid #2c3e50; padding: 14px; border-radius: 12px; 
    text-decoration: none; font-weight: bold; cursor: pointer; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.2s;
  }
  .entry-btn:active { transform: scale(0.98); background: #f8f9fa; }

  .footer { margin-top: 25px; font-size: 12px; color: #aaa; text-align: center; line-height: 1.6; }
  
  #modalOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f0f2f5; z-index: 9999; animation: slideUp 0.3s ease-out; }
  @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
  .modal-header { position: absolute; top: 0; left: 0; width: 100%; height: 50px; background: #2c3e50; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; color: white; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
  .close-btn { background: none; border: none; color: white; font-size: 16px; cursor: pointer; font-weight: bold; }
  .modal-body { width: 100%; height: 100%; padding-top: 50px; overflow: hidden; }
  iframe { width: 100%; height: 100%; border: none; }
  
  /* é™¤éŒ¯æ¡† */
  #debugBox { display: none; background: #ffebee; color: #c62828; padding: 10px; margin-bottom: 10px; border-radius: 5px; text-align: left; font-size: 13px; border: 1px solid #ef5350; }
</style>
</head>
<body>

<div class="container">
  <div class="card">
    <h2>âš–ï¸ ç«¹åŒ—è³‡æºå¤©ç§¤</h2>
    <div class="sub-header">æ‚¨çš„ç´ç¨…éŒ¢ï¼Œ<br>æ˜¯å»ºè¨­äº†æ‚¨ï¼Œé‚„æ˜¯è·¯éæ‚¨ï¼Ÿ</div>
    
    <div id="debugBox"></div>
    <div id="eventStatus" class="live-tag">é€£ç·šä¸­...</div>
    
    <p style="text-align: center; color: #666; font-size: 14px; margin-bottom: 20px;">
      è¼¸å…¥æ‚¨çš„ä½ç½®ï¼Œæ¸¬æ¸¬çœ‹é€™å ´æ´»å‹•<br>å°æ‚¨ä¾†èªªæ˜¯ã€Œç¦åˆ©ã€é‚„æ˜¯ã€Œé™ä¸å¯åŠã€ï¼Ÿ
    </p>

    <button class="btn" onclick="getLocation()">ğŸ“ å•Ÿå‹•å®šä½åˆ†æ</button>

    <div id="output" class="result-area">
      <div class="metric-row">
        <div class="metric-label">æœ¬é€±ç„¦é»<br><a href="#" id="goodLink" target="_blank" class="nav-link"><span id="goodName">è®€å–ä¸­...</span></a></div>
        <div class="metric-val" id="goodDist">...</div>
      </div>
      
      <div class="metric-row">
        <div class="metric-label">å°ç…§æŒ‡æ¨™<br><a href="#" id="badLink" target="_blank" class="nav-link"><span id="badName">è®€å–ä¸­...</span></a></div>
        <div class="metric-val" id="badDist">...</div>
      </div>

      <div id="chiefBox" class="chief-msg-box">
        <div class="chief-title">ğŸ“¢ è¥¿å€åœŸåœ°å…¬ç­†è¨˜</div>
        <div class="chief-content" id="chiefMsg"></div>
      </div>

      <div id="analysisBox" class="analysis-box"><div id="roleBadge" class="role-badge"></div><div id="analysisText"></div></div>
      
      <div class="action-group">
        <button class="btn-share btn-full" onclick="shareResult()">
           <span class="btn-icon">ğŸ’¬</span> ä¸€éµåˆ†äº«æª¢æ¸¬çµæœ
        </button>
        
        <button class="btn-group btn-full" onclick="window.open('https://line.me/ti/g2/RaDs4ZL02O8n-_VpCNC1f-kW95ZBsvyveYEyAw?utm_source=invitation&utm_medium=link_copy&utm_campaign=default')">
           <span class="btn-icon">ğŸ”¥</span> é€²ä¾†å–æš–å•Š
        </button>
      </div>

      <div class="entry-box">
          <p style="font-size:14px; color:#666; margin:0 0 10px 0;">è¦ºå¾—ä¸æº–ï¼Ÿä¾†çœ‹çœ‹å…¶ä»–æ´»å‹•éƒ½è¾¦åœ¨å“ªï¼Ÿ</p>
          <button class="entry-btn" onclick="openEvents()">ğŸ“… æª¢è¦–å…¨ç«¹åŒ—æ´»å‹•åˆ†ä½ˆ</button>
      </div>

    </div>

    <div class="footer">
      æ•¸æ“šåƒ…ä¾›åƒè€ƒï¼Œ<br>å¦‚æœ‰é›·åŒ......é‚£å°±æ˜¯è¥¿å€æ—¥å¸¸ã€‚
    </div>
  </div>
</div>

<div id="modalOverlay">
  <div class="modal-header">
    <span>ğŸ“… ç«¹åŒ—æ´»å‹•åˆ†ä½ˆåœ°åœ–</span>
    <button class="close-btn" onclick="closeEvents()">âœ• é—œé–‰è¿”å›</button>
  </div>
  <div class="modal-body">
    <iframe src="events2.html"></iframe>
  </div>
</div>

<script>
  // å…¨åŸŸéŒ¯èª¤æ•æ‰
  window.onerror = function(msg, url, line) {
    var d = document.getElementById('debugBox');
    d.style.display = 'block';
    d.innerHTML = "â›” <b>ç¨‹å¼éŒ¯èª¤ï¼š</b>" + msg + "<br>Line: " + line;
    return false;
  };

  // å¤©ç§¤è³‡æ–™åº«ç¶²å€ (å·²æ¸…æ´—)
  var sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQtIyD2tguRY3fN-Pe9Fwe-07P_0MWG8G7Z6XNfOE9qpk2U-b_NjBRpA26o4FenSxkQMpbfvCLjyu46/pub?output=csv'; 

  var eventData = {
    name: "è³‡æ–™è®€å–ä¸­", lat: 24.8135, lng: 121.0265,
    badName: "è³‡æ–™è®€å–ä¸­", badLat: 24.8550, badLng: 120.9650,
    chiefMsg: "",
    limitWest: 3.5, limitEast: 3.0,
    titleWest: "åŸå¸‚å®ˆè­·è€…", textWest: "æ„Ÿè¬æ‚¨æ‰¿æ“”äº†ç«¹åŒ—çš„é‹è½‰é‡ä»»ã€‚",
    titleEast: "è³‡æºæ ¸å¿ƒå€", textEast: "æ‚¨ä½æ–¼ç«¹åŒ—è³‡æºæœ€è±å¯Œçš„å€åŸŸã€‚",
    textNormal: "è©¦è‘—æ¯”è¼ƒé€™å…©å€‹è·é›¢ï¼Œæ‚¨èªç‚ºç«¹åŒ—çš„æ±ã€è¥¿å€ç™¼å±•ï¼Œç›®å‰æ˜¯å¹³è¡¡çš„å—ï¼Ÿ"
  };
  var shareText = "";

  function openEvents() { document.getElementById('modalOverlay').style.display = 'block'; document.body.style.overflow = 'hidden'; }
  function closeEvents() { document.getElementById('modalOverlay').style.display = 'none'; document.body.style.overflow = 'auto'; }

  function showError(msg) {
    var box = document.getElementById('debugBox');
    box.style.display = 'block';
    box.innerHTML = "âš ï¸ <b>é€£ç·šéŒ¯èª¤ï¼š</b><br>" + msg;
    document.getElementById('eventStatus').innerText = "â— é€£ç·šå¤±æ•—";
    document.getElementById('eventStatus').style.background = "#ffebee";
    document.getElementById('eventStatus').style.color = "#c62828";
  }

  function parseCSV(text) {
    var rows = []; var currentRow = []; var cell = ""; var inQuote = false;
    for(var i=0; i<text.length; i++) {
      var c = text[i];
      if(c === '"') { inQuote = !inQuote; }
      else if(c === ',' && !inQuote) { currentRow.push(cell); cell = ""; }
      else if((c === '\r' || c === '\n') && !inQuote) {
        if(cell || currentRow.length) currentRow.push(cell);
        if(currentRow.length) rows.push(currentRow);
        currentRow = []; cell = "";
      } else { cell += c; }
    }
    if(cell || currentRow.length) { currentRow.push(cell); rows.push(currentRow); }
    return rows;
  }

  window.onload = function() {
    fetch(sheetUrl)
      .then(function(res) {
        if(!res.ok) throw new Error("ç¶²è·¯å›æ‡‰éŒ¯èª¤");
        return res.text();
      })
      .then(function(text) {
        try {
          var rows = parseCSV(text);
          if(rows.length < 2) throw new Error("è³‡æ–™åº«ç‚ºç©º");
          var cols = rows[1];
          function clean(s) { return s ? s.trim() : ""; }
          
          eventData.name = clean(cols[0]);
          eventData.lat = parseFloat(cols[1]);
          eventData.lng = parseFloat(cols[2]);
          eventData.badName = clean(cols[3]);
          eventData.badLat = parseFloat(cols[4]);
          eventData.badLng = parseFloat(cols[5]);
          
          if(cols[6]) eventData.chiefMsg = clean(cols[6]);
          if(cols[7]) eventData.limitWest = parseFloat(cols[7]);
          if(cols[8]) eventData.limitEast = parseFloat(cols[8]);
          if(cols[9]) eventData.titleWest = clean(cols[9]);
          if(cols[10]) eventData.textWest = clean(cols[10]);
          if(cols[11]) eventData.titleEast = clean(cols[11]);
          if(cols[12]) eventData.textEast = clean(cols[12]);
          if(cols[13]) eventData.textNormal = clean(cols[13]);

          document.getElementById('eventStatus').innerText = "â— æœ¬é€±ç†±é»ï¼š" + eventData.name;
          document.getElementById('goodName').innerText = eventData.name + " (å°èˆª)";
          document.getElementById('goodLink').href = "https://www.google.com/maps/search/?api=1&query=" + eventData.lat + "," + eventData.lng;
          document.getElementById('badName').innerText = eventData.badName + " (å°èˆª)";
          document.getElementById('badLink').href = "https://www.google.com/maps/search/?api=1&query=" + eventData.badLat + "," + eventData.badLng;
        } catch(e) {
          showError("è³‡æ–™è§£æéŒ¯èª¤ï¼š" + e.message);
        }
      })
      .catch(function(err) {
        showError("é€£ç·šéŒ¯èª¤ï¼š" + err.message);
      });
  };

  function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPos, showErr);
    } else {
        alert("ä¸æ”¯æ´å®šä½");
    }
  }
  
  function showPos(position) { calc(position.coords.latitude, position.coords.longitude); }
  function showErr(error) { alert("å®šä½å¤±æ•—ï¼Œåˆ‡æ›è‡³ã€è¥¿å€æ¨¡æ“¬è¦–è§’ã€‘"); calc(24.845, 120.970); }

  function calc(lat, lng) {
    var dGood = getDist(lat, lng, eventData.lat, eventData.lng);
    var dBad = getDist(lat, lng, eventData.badLat, eventData.badLng);
    
    document.getElementById("goodDist").innerText = dGood.toFixed(1) + " km";
    document.getElementById("badDist").innerText = dBad.toFixed(1) + " km";
    
    if(eventData.chiefMsg) {
        document.getElementById("chiefMsg").innerText = eventData.chiefMsg;
        document.getElementById("chiefBox").style.display = "block";
    }
    
    var role = "ä¸€èˆ¬å¸‚æ°‘", text = eventData.textNormal, style = "role-citizen";
    
    if (dBad < eventData.limitWest) {
        role = eventData.titleWest; text = eventData.textWest; style = "role-guardian";
    } else if (dGood < eventData.limitEast) {
        role = eventData.titleEast; text = eventData.textEast; style = "role-noble";
    }
    
    shareText = "æˆ‘é›¢ã€Œ" + eventData.badName + "ã€" + dBad.toFixed(1) + "kmï¼Œé›¢ã€Œ" + eventData.name + "ã€" + dGood.toFixed(1) + "kmã€‚å¿«ä¾†æ¸¬ï¼š";
    
    var box = document.getElementById("analysisBox");
    box.className = "analysis-box " + style;
    document.getElementById("roleBadge").innerText = role;
    document.getElementById("analysisText").innerText = text;
    
    document.getElementById("output").style.display = "block";
  }
  
  function shareResult() {
    window.open('https://line.me/R/msg/text/?' + encodeURIComponent(shareText + "\n" + window.location.href));
  }

  function getDist(lat1,lon1,lat2,lon2) {
    var R = 6371;
    var p = 0.017453292519943295;
    var a = 0.5 - Math.cos((lat2 - lat1) * p)/2 + Math.cos(lat1 * p) * Math.cos(lat2 * p) * (1 - Math.cos((lon2 - lon1) * p))/2;
    return 12742 * Math.asin(Math.sqrt(a));
  }
</script>
</body>
</html>
