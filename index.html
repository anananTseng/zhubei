<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ç«¹åŒ—è³‡æºå¤©ç§¤</title>
<style>
  /* æ¨£å¼ä¿æŒä¸è®Š */
  * { box-sizing: border-box; }
  body { 
    font-family: "Helvetica Neue", Helvetica, "Microsoft JhengHei", Arial, sans-serif; 
    background-color: #f0f2f5; margin: 0; padding: 0; min-height: 100vh;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
  }
  .container { width: 100%; max-width: 450px; padding: 20px; }
  .card { 
    background: #fff; border-radius: 16px; padding: 25px; width: 100%; 
    box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-top: 6px solid #2c3e50; 
  }
  h2 { color: #2c3e50; margin: 0 0 5px 0; font-size: 22px; text-align: center; }
  .sub-header { font-size: 13px; color: #7f8c8d; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; text-align: center; }
  
  .live-tag { 
    display: block; background: #e8f5e9; color: #2e7d32; padding: 8px; 
    border-radius: 6px; font-size: 14px; font-weight: bold; margin-bottom: 20px; 
    border: 1px solid #c8e6c9; text-align: center;
  }
  
  .btn { 
    background: #2c3e50; color: white; border: none; padding: 16px 0; 
    font-size: 18px; border-radius: 12px; cursor: pointer; width: 100%; 
    font-weight: bold; transition: 0.2s; box-shadow: 0 4px 12px rgba(44, 62, 80, 0.3);
  }
  .btn:active { transform: scale(0.98); }
  
  .result-area { display: none; margin-top: 25px; text-align: left; animation: popIn 0.4s ease-out; }
  @keyframes popIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
  
  .metric-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #eee; position: relative; }
  .metric-label { font-size: 13px; color: #555; flex: 1; }
  .metric-val { font-size: 20px; font-weight: bold; color: #2c3e50; text-align: right; }
  
  .nav-link { display: inline-flex; align-items: center; color: #2980b9; text-decoration: none; font-weight: bold; font-size: 13px; margin-top: 4px; padding: 4px 8px; background: #eef6fb; border-radius: 4px; transition: 0.2s; border: 1px solid #d6eaf8; }
  .nav-link:hover { background: #d6eaf8; }
  .nav-icon { margin-right: 4px; font-size: 14px; }

  .chief-msg-box { margin-top: 20px; background: #fff5f8; padding: 15px; border-radius: 10px; border-left: 5px solid #e91e63; display: none; }
  .chief-title { font-size: 13px; font-weight: bold; color: #e91e63; margin-bottom: 8px; }
  .chief-content { font-size: 15px; color: #333; line-height: 1.6; }

  .analysis-box { margin-top: 20px; padding: 20px; border-radius: 10px; }
  .role-badge { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-bottom: 10px; }
  .analysis-text { font-size: 15px; line-height: 1.6; font-weight: 500; }
  
  .role-guardian { background: #fff8e1; color: #856404; border: 1px solid #ffeeba; }
  .role-guardian .role-badge { background: #ffc107; color: #fff; }
  .role-noble { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
  .role-noble .role-badge { background: #17a2b8; color: #fff; }
  .role-citizen { background: #e2e3e5; color: #383d41; border: 1px solid #d6d8db; }
  .role-citizen .role-badge { background: #6c757d; color: #fff; }
  
  .action-group { margin-top: 25px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .btn-full { grid-column: span 2; }
  .btn-share { background: #06c755; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 15px; display: flex; align-items: center; justify-content: center; }
  .btn-group { background: #3498db; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 15px; display: flex; align-items: center; justify-content: center; }
  .btn-icon { margin-right: 6px; }

  .footer { margin-top: 25px; font-size: 12px; color: #aaa; text-align: center; }
  
  /* éŒ¯èª¤è¨Šæ¯å°ˆç”¨ */
  .error-msg { color: red; font-size: 12px; margin-top: 10px; background: #ffe6e6; padding: 10px; border-radius: 5px; display: none; }
</style>
</head>
<body>

<div class="container">
  <div class="card">
    <h2>âš–ï¸ ç«¹åŒ—è³‡æºå¤©ç§¤</h2>
    <div class="sub-header">é›¢æ‚¨æœ€è¿‘çš„çœŸç›¸æ˜¯ï¼Ÿ</div>
    
    <div id="eventStatus" class="live-tag">é€£ç·šä¸­...</div>
    <div id="debugInfo" class="error-msg"></div>
    
    <p style="text-align: center; color: #666; font-size: 14px;">
      è¼¸å…¥ä½ç½®ï¼Œæ¸¬æ¸¬çœ‹é€™å ´æ´»å‹•<br>å°æ‚¨ä¾†èªªæ˜¯ã€Œç¦åˆ©ã€é‚„æ˜¯ã€Œé™ä¸å¯åŠã€ï¼Ÿ
    </p>

    <button class="btn" onclick="getLocation()">ğŸ“ å•Ÿå‹•å®šä½åˆ†æ</button>

    <div id="output" class="result-area">
      <div class="metric-row">
        <div class="metric-label">
          é›¢æœ¬é€±ç„¦é»<br>
          <a href="#" id="goodLink" target="_blank" class="nav-link">
            <span class="nav-icon">ğŸ“</span><span id="goodName">è®€å–ä¸­...</span>
          </a>
        </div>
        <div class="metric-val" id="goodDist">...</div>
      </div>
      
      <div class="metric-row">
        <div class="metric-label">
          é›¢å°ç…§æŒ‡æ¨™<br>
          <a href="#" id="badLink" target="_blank" class="nav-link">
            <span class="nav-icon">âš ï¸</span><span id="badName">è®€å–ä¸­...</span>
          </a>
        </div>
        <div class="metric-val" id="badDist">...</div>
      </div>

      <div id="chiefBox" class="chief-msg-box">
        <div class="chief-title">ğŸ“¢ é‡Œé•·ç­†è¨˜</div>
        <div class="chief-content" id="chiefMsg">...</div>
      </div>

      <div id="analysisBox" class="analysis-box">
        <div id="roleBadge" class="role-badge">åˆ†æä¸­</div>
        <div id="analysisText" class="analysis-text"></div>
      </div>

        <div class="action-group">
        <button class="btn-group btn-full" onclick="joinLineGroup()">
           <span class="btn-icon">ğŸ‘¥</span> åŠ å…¥ç«¹åŒ—åœ¨åœ°è¨è«–ç¤¾ç¾¤
        </button>
        <button class="btn-share btn-full" onclick="shareResult()">
           <span class="btn-icon">ğŸ’¬</span> ä¸€éµåˆ†äº«æª¢æ¸¬çµæœ
        </button>
      </div>

      <div style="margin-top: 25px; border-top: 1px dashed #ccc; padding-top: 20px; text-align: center;">
          <p style="font-size:14px; color:#666; margin:0 0 10px 0;">æƒ³çŸ¥é“ç«¹åŒ—æœ€è¿‘é‚„æœ‰å“ªäº›æ´»å‹•ï¼Ÿ</p>
          <a href="events.html" style="display:block; background:#fff; color:#2c3e50; border:2px solid #2c3e50; padding:14px; border-radius:12px; text-decoration:none; font-weight:bold; transition:0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
             ğŸ“… æŸ¥çœ‹ç«¹åŒ—å¸‚æ´»å‹•æ˜ç´°
          </a>
      </div>
      ```

---

### ğŸ“ è³‡æ–™åº« (Excel) å¡«å¯«ç¯„æœ¬

ç‚ºäº†ç¢ºä¿ `events.html` èƒ½å®Œç¾é‹ä½œï¼Œè«‹æ‚¨çš„ Excel (æ´»å‹•æ˜ç´°) ä¾ç…§é€™å€‹é †åºå¡«å¯«ï¼š

| A | B | C | D | E |
| :--- | :--- | :--- | :--- | :--- |
| **æ´»å‹•æ—¥æœŸ** | **æ´»å‹•åç¨±** | **ä¸»è¾¦å–®ä½** | **æ´»å‹•åœ°é»** | **é€£çµ (é¸å¡«)** |
| 11/29 | ç«¹åŒ—éŸ³æ¨‚æ•…äº‹ | ç«¹åŒ—å¸‚å…¬æ‰€ | æ°´åœ³æ£®æ—å…¬åœ’ | https://... |
| 12/05 | è¥¿å€æ·¨ç˜ | å´‡ç¾©é‡Œè¾¦å…¬è™• | æ–°æœˆæ²™ç£ | (ç©ºç™½) |

**âœ¨ è‡ªå‹•åŒ–äº®é»ï¼š**
1.  **E æ¬„è‹¥ç•™ç©º**ï¼šç¶²é ä¸Šå°±ä¸æœƒé¡¯ç¤ºã€ŒæŸ¥çœ‹å®˜æ–¹è³‡è¨Šã€çš„æŒ‰éˆ•ï¼Œç‰ˆé¢æœƒè‡ªå‹•ç¸®çŸ­ï¼Œå¾ˆä¹¾æ·¨ã€‚
2.  **D æ¬„åµæ¸¬**ï¼šå¦‚æœæ‚¨åœ¨åœ°é»å¯«ã€Œ**è¥¿å€**æ–°æœˆæ²™ç£ã€ï¼Œå¡ç‰‡å·¦é‚Šæœƒè‡ªå‹•è®Šæˆ**ç¶ è‰²**ï¼›å¯«ã€Œ**æ±å€**æ°´åœ³å…¬åœ’ã€ï¼Œæœƒè®Šæˆ**æ©˜è‰²**ã€‚é€™æ˜¯ä¸€å€‹éš±è—çš„å°å½©è›‹ï¼

é€™æ¨£è¨­å®šå®Œï¼Œæ‚¨çš„å¹³å°å°±å…·å‚™äº†å®Œæ•´çš„ã€Œå°æµ -> éœ‡æ’¼ -> æœå‹™ã€ç”Ÿæ…‹ç³»äº†ï¼
    </div>
    <div class="footer">æœ¬å·¥å…·åƒ…ä¾›å¸‚æ”¿è¨è«–åƒè€ƒ</div>
  </div>
</div>

<script>
  // â˜…â˜…â˜… è«‹åœ¨é€™è£¡è²¼ä¸Šæ‚¨çš„ CSV ç¶²å€ â˜…â˜…â˜…
  var sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQtIyD2tguRY3fN-Pe9Fwe-07P_0MWG8G7Z6XNfOE9qpk2U-b_NjBRpA26o4FenSxkQMpbfvCLjyu46/pub?output=csv'; 
  // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…

  var lineGroupUrl = 'https://line.me/ti/g2/RaDs4ZL02O8n-_VpCNC1f-kW95ZBsvyveYEyAw?utm_source=invitation&utm_medium=link_copy&utm_campaign=default';

  // é è¨­è³‡æ–™ï¼Œé˜²å‘†ç”¨
  var eventData = {
    name: "è³‡æ–™è®€å–ä¸­", lat: 24.8135, lng: 121.0265,
    badName: "è³‡æ–™è®€å–ä¸­", badLat: 24.8550, badLng: 120.9650,
    chiefMsg: "",
    limitWest: 3.5, limitEast: 3.0,
    titleWest: "åŸå¸‚å®ˆè­·è€…", textWest: "æ„Ÿè¬æ‚¨æ‰¿æ“”äº†ç«¹åŒ—çš„é‹è½‰é‡ä»»ã€‚",
    titleEast: "è³‡æºæ ¸å¿ƒå€", textEast: "æ‚¨ä½æ–¼ç«¹åŒ—è³‡æºæœ€è±å¯Œçš„å€åŸŸã€‚",
    textNormal: "è©¦è‘—æ¯”è¼ƒé€™å…©å€‹è·é›¢ï¼Œæ‚¨èªç‚ºç«¹åŒ—çš„æ±ã€è¥¿å€ç™¼å±•ï¼Œç›®å‰æ˜¯å¹³è¡¡çš„å—ï¼Ÿ"
  };
  var shareText = "";

  // â˜…â˜…â˜… V11.0 æ ¸å¿ƒï¼šå¼·åŠ› CSV è§£æå™¨ (è™•ç†é€—è™Ÿèˆ‡å¼•è™Ÿ) â˜…â˜…â˜…
  function parseCSV(text) {
    const rows = [];
    let currentRow = [];
    let currentCell = '';
    let insideQuote = false;
    
    for (let i = 0; i < text.length; i++) {
        const char = text[i];
        const nextChar = text[i+1];
        
        if (char === '"') {
            if (insideQuote && nextChar === '"') { // è™•ç†é›™å¼•è™Ÿè½‰ç¾©
                currentCell += '"';
                i++;
            } else {
                insideQuote = !insideQuote;
            }
        } else if (char === ',' && !insideQuote) {
            currentRow.push(currentCell.trim());
            currentCell = '';
        } else if ((char === '\r' || char === '\n') && !insideQuote) {
            if (currentCell || currentRow.length > 0) {
                currentRow.push(currentCell.trim());
                rows.push(currentRow);
            }
            currentRow = [];
            currentCell = '';
            if (char === '\r' && nextChar === '\n') i++;
        } else {
            currentCell += char;
        }
    }
    if (currentCell || currentRow.length > 0) {
        currentRow.push(currentCell.trim());
        rows.push(currentRow);
    }
    return rows;
  }

  window.onload = function() {
    console.log("é–‹å§‹é€£ç·š...");
    fetch(sheetUrl)
      .then(response => {
        if (!response.ok) throw new Error("ç¶²è·¯å›æ‡‰å¤±æ•—: " + response.status);
        return response.text();
      })
      .then(data => {
        try {
            // ä½¿ç”¨å¼·åŠ›è§£æå™¨
            var rows = parseCSV(data);
            
            if (rows.length < 2) throw new Error("Excel è³‡æ–™ä¸è¶³ 2 åˆ—");
            
            var cols = rows[1]; // è®€å–ç¬¬ 2 åˆ— (Index 1)
            
            if(cols.length < 6) throw new Error("æ¬„ä½æ•¸é‡ä¸è¶³ (è‡³å°‘è¦ A~F æ¬„)");

            // è³¦å€¼ (åŠ å…¥æ›´å¤šé˜²éŒ¯æª¢æŸ¥)
            eventData.name = cols[0] || "ç„¡åç¨±";
            eventData.lat = parseFloat(cols[1]) || 24.8135;
            eventData.lng = parseFloat(cols[2]) || 121.0265;
            eventData.badName = cols[3] || "ç„¡åç¨±";
            eventData.badLat = parseFloat(cols[4]) || 24.8550;
            eventData.badLng = parseFloat(cols[5]) || 120.9650;

            if(cols[6]) eventData.chiefMsg = cols[6];

            if(cols[7]) eventData.limitWest = parseFloat(cols[7]);
            if(cols[8]) eventData.limitEast = parseFloat(cols[8]);
            if(cols[9]) eventData.titleWest = cols[9];
            if(cols[10]) eventData.textWest = cols[10];
            if(cols[11]) eventData.titleEast = cols[11];
            if(cols[12]) eventData.textEast = cols[12];
            if(cols[13]) eventData.textNormal = cols[13];

            // æ›´æ–°ç•«é¢
            document.getElementById('eventStatus').innerText = "â— æœ¬é€±ç†±é»ï¼š" + eventData.name;
            
            // ä½¿ç”¨æ¨™æº– Google Maps é€£çµ
            var mapBase = "https://www.google.com/maps?q=";
            document.getElementById('goodName').innerText = eventData.name + " (å°èˆª)";
            document.getElementById('goodLink').href = mapBase + eventData.lat + "," + eventData.lng;
            
            document.getElementById('badName').innerText = eventData.badName + " (å°èˆª)";
            document.getElementById('badLink').href = mapBase + eventData.badLat + "," + eventData.badLng;
            
        } catch(e) {
            console.error(e);
            document.getElementById('eventStatus').innerText = "âš ï¸ è³‡æ–™è®€å–éŒ¯èª¤";
            document.getElementById('debugInfo').style.display = "block";
            document.getElementById('debugInfo').innerText = "éŒ¯èª¤è©³æƒ…ï¼š" + e.message + "\nè«‹ç¢ºèª CSV ç¶²å€æ­£ç¢ºï¼Œä¸” Excel è‡³å°‘æœ‰ A~F æ¬„è³‡æ–™ã€‚";
        }
      })
      .catch(err => {
          console.error(err);
          document.getElementById('eventStatus').innerText = "âš ï¸ é€£ç·šå¤±æ•—";
          document.getElementById('debugInfo').style.display = "block";
          document.getElementById('debugInfo').innerText = "é€£ç·šéŒ¯èª¤ï¼šç„¡æ³•è®€å– Google è©¦ç®—è¡¨ã€‚\nè«‹æª¢æŸ¥ç¶²å€æ˜¯å¦ç‚º 'é€—è™Ÿåˆ†éš”å€¼ (.csv)' æ ¼å¼ã€‚\nç›®å‰ç¶²å€ï¼š" + sheetUrl;
      });
  };

  function getLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(showPos, showErr);
    } else {
      alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½ï¼Œæˆ–æ¬Šé™è¢«æ‹’çµ•ã€‚");
    }
  }

  function showPos(position) { calc(position.coords.latitude, position.coords.longitude); }
  function showErr(error) { alert("å®šä½å¤±æ•—æˆ–æ‹’çµ•æˆæ¬Šã€‚\nå°‡ç‚ºæ‚¨åˆ‡æ›è‡³ã€è¥¿å€æ¨¡æ“¬è¦–è§’ã€‘ã€‚"); calc(24.845, 120.970); }

  function calc(lat, lng) {
    let dGood = getDist(lat, lng, eventData.lat, eventData.lng);
    let dBad = getDist(lat, lng, eventData.badLat, eventData.badLng);
    
    document.getElementById("goodDist").innerText = dGood.toFixed(1) + " km";
    document.getElementById("badDist").innerText = dBad.toFixed(1) + " km";
    
    if(eventData.chiefMsg) {
      document.getElementById("chiefMsg").innerText = eventData.chiefMsg;
      document.getElementById("chiefBox").style.display = "block";
    }

    let role = ""; let text = ""; let styleClass = "";
    
    if (dBad < eventData.limitWest) {
      role = eventData.titleWest;
      text = eventData.textWest;
      styleClass = "role-guardian";
      shareText = "ğŸ˜± æˆ‘å®¶é›¢ã€Œ" + eventData.badName + "ã€åªæœ‰ " + dBad.toFixed(1) + "kmï¼ä½†é›¢ã€Œ" + eventData.name + "ã€æœ‰ " + dGood.toFixed(1) + "kmã€‚å¿«ä¾†æ¸¬æ¸¬ï¼š";
    } 
    else if (dGood < eventData.limitEast) {
      role = eventData.titleEast;
      text = eventData.textEast;
      styleClass = "role-noble";
      shareText = "âœ¨ æˆ‘ä½åœ¨ç«¹åŒ—è³‡æºæ ¸å¿ƒå€ï¼é›¢ã€Œ" + eventData.name + "ã€åªæœ‰ " + dGood.toFixed(1) + "kmã€‚å¿«ä¾†æ¸¬æ¸¬ä½ çš„è³‡æºè·é›¢ï¼š";
    } 
    else {
      role = "ä¸€èˆ¬å¸‚æ°‘";
      text = eventData.textNormal; 
      styleClass = "role-citizen";
      shareText = "ğŸ¤” åŸä¾†æˆ‘é›¢ã€Œ" + eventData.name + "ã€æœ‰ " + dGood.toFixed(1) + "kmã€‚ç«¹åŒ—çš„è³‡æºåˆ†é…å¹³å‡å—ï¼Ÿå¿«ä¾†æ¸¬æ¸¬ä½ çš„ï¼š";
    }
    
    let box = document.getElementById("analysisBox");
    box.className = "analysis-box " + styleClass;
    document.getElementById("roleBadge").innerText = role;
    document.getElementById("analysisText").innerText = text;
    document.getElementById("output").style.display = "block";
  }

  function joinLineGroup() { window.open(lineGroupUrl); }

  function shareResult() {
    var url = window.location.href;
    var finalMsg = shareText + "\n" + url;
    window.open('https://line.me/R/msg/text/?' + encodeURIComponent(finalMsg));
  }

  function getDist(lat1,lon1,lat2,lon2) {
    var R = 6371; 
    var dLat = (lat2-lat1) * (Math.PI/180);
    var dLon = (lon2-lon1) * (Math.PI/180);
    var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*(Math.PI/180)) * Math.cos(lat2*(Math.PI/180)) * Math.sin(dLon/2) * Math.sin(dLon/2);
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
    return R * c;
  }
</script>
</body>
</html>
