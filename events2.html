<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«¹åŒ—æ´»å‹•åˆ†ä½ˆåœ°åœ–</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #27ae60;
            --bg-color: #f4f6f9;
            --card-bg: #ffffff;
            --text-color: #333;
            --gray-text: #666;
            --status-coming: #f39c12;
            --status-active: #27ae60;
            --status-today: #e74c3c;
            --status-ended: #95a5a6;
        }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 0; line-height: 1.6; }
        
        header { background: linear-gradient(135deg, #1a2a3a, #2c3e50); color: white; padding: 2.5rem 1rem; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.15); position: relative; }
        header h1 { margin: 0; font-size: 2rem; letter-spacing: 2px; font-weight: 700; }
        header p { margin-top: 10px; opacity: 0.85; font-size: 1rem; font-weight: 300; }

        .container { max-width: 1100px; margin: 2rem auto; padding: 0 20px; padding-bottom: 80px; /* é ç•™åº•éƒ¨ç©ºé–“ */ }
        
        /* ç¯©é¸åˆ— */
        .controls-bar {
            background: white; padding: 15px 20px; border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; justify-content: space-between;
            align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 2rem;
            position: sticky; top: 0; z-index: 90;
        }
        
        .filters { display: flex; gap: 15px; flex-wrap: wrap; }
        .filter-group { display: flex; align-items: center; gap: 8px; }
        .filter-group label { font-weight: 500; color: #555; font-size: 0.95rem; }
        
        select { padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd; font-size: 0.95rem; cursor: pointer; }
        select:focus { outline: none; border-color: var(--accent-color); }

        #loading { text-align: center; padding: 3rem; font-size: 1.2rem; color: var(--gray-text); }
        
        .event-list { display: grid; gap: 1.5rem; grid-template-columns: 1fr; }
        @media (min-width: 768px) { .event-list { grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); } }

        .event-card {
            background: var(--card-bg); border-radius: 12px; padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02); transition: all 0.3s ease;
            border: 1px solid rgba(0,0,0,0.05); display: flex; flex-direction: column;
            position: relative; overflow: hidden;
        }
        .event-card:hover { transform: translateY(-5px); box-shadow: 0 12px 20px rgba(0,0,0,0.08); }
        .event-card.ended { opacity: 0.6; filter: grayscale(0.8); background-color: #f9f9f9; }

        .status-badge { position: absolute; top: 0; left: 0; padding: 6px 12px; font-size: 0.8rem; font-weight: 700; color: white; border-bottom-right-radius: 12px; z-index: 10; }
        .bg-coming { background-color: var(--status-coming); }
        .bg-active { background-color: var(--status-active); }
        .bg-today { background-color: var(--status-today); animation: pulse 2s infinite; }
        .bg-ended { background-color: var(--status-ended); }

        .category-tag { position: absolute; top: 15px; right: 15px; font-size: 0.75rem; padding: 4px 10px; border-radius: 20px; background-color: #f0f2f5; color: #666; font-weight: 600; }
        .cat-celebration { background-color: #fff3cd; color: #856404; }
        .cat-art { background-color: #e2e3e5; color: #383d41; }
        .cat-lecture { background-color: #d1ecf1; color: #0c5460; }

        .event-date { color: var(--accent-color); font-weight: 700; font-size: 0.9rem; margin-bottom: 8px; margin-top: 15px; display: flex; align-items: center; }
        .event-title { font-size: 1.3rem; font-weight: 700; margin: 0 0 15px 0; color: var(--primary-color); line-height: 1.4; flex-grow: 1; }

        .info-row { display: flex; align-items: flex-start; margin-bottom: 8px; font-size: 0.9rem; color: #555; }
        .info-icon { min-width: 18px; height: 18px; margin-right: 10px; margin-top: 3px; fill: #888; }

        .map-link { color: #555; text-decoration: none; border-bottom: 1px dashed #999; transition: all 0.2s; cursor: pointer; }
        .map-link:hover { color: #e74c3c; border-bottom: 1px solid #e74c3c; }
        .map-link::after { content: ' â†—'; font-size: 0.8em; opacity: 0.7; }

        .btn-link { margin-top: 20px; display: block; width: 100%; text-align: center; padding: 10px 0; background-color: var(--primary-color); color: white; text-decoration: none; border-radius: 8px; font-weight: 500; transition: background 0.2s; }
        .btn-link:hover { background-color: #34495e; }
        .btn-link.disabled { background-color: #e9ecef; color: #adb5bd; cursor: default; pointer-events: none; }

        /* æ‡¸æµ®å›å ±æŒ‰éˆ• */
        .fab-btn {
            position: fixed; bottom: 30px; right: 30px;
            background-color: var(--primary-color); color: white;
            padding: 12px 20px; border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            text-decoration: none; font-weight: bold; display: flex; align-items: center; gap: 8px;
            transition: transform 0.2s, background 0.2s; z-index: 999;
        }
        .fab-btn:hover { transform: translateY(-3px); background-color: #34495e; }
        
        /* å…è²¬è²æ˜ Footer */
        footer { background-color: #2c3e50; color: #bdc3c7; padding: 3rem 1rem; text-align: center; font-size: 0.85rem; margin-top: 4rem; }
        .disclaimer { max-width: 800px; margin: 10px auto; opacity: 0.7; font-size: 0.8rem; line-height: 1.5; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <header>
        <h1>ç«¹åŒ—æ´»å‹•åˆ†ä½ˆåœ°åœ–</h1>
        <p>æŒæ¡åŸå¸‚è„ˆå‹• Â· äº«å—ç¾å¥½ç”Ÿæ´»</p>
    </header>

    <div class="container">
        <div class="controls-bar">
            <div style="font-size:0.9rem; color:#888;" id="update-time">è³‡æ–™è¼‰å…¥ä¸­...</div>
            <div class="filters">
                <div class="filter-group">
                    <select id="month-filter"><option value="all">å…¨éƒ¨æœˆä»½</option></select>
                </div>
                <div class="filter-group">
                    <select id="cat-filter"><option value="all">å…¨éƒ¨é¡å‹</option></select>
                </div>
                <div class="filter-group">
                    <select id="status-filter">
                        <option value="active" selected>é€²è¡Œä¸­/å³å°‡é–‹å§‹</option>
                        <option value="all">å…¨éƒ¨ (å«æ­·å²æ´»å‹•)</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="loading">æ­£åœ¨è®€å–æœ€æ–°æ´»å‹•è³‡æ–™åº«...</div>
        <div class="event-list" id="event-container"></div>
    </div>

    <a href="#" id="feedback-btn" target="_blank" class="fab-btn">
        <span>ğŸ</span> å›å ± / æŠ•ç¨¿
    </a>

    <footer>
        <p>Â© 2025 ç«¹åŒ—æ´»å‹•åˆ†ä½ˆåœ°åœ– | è³‡æ–™ä¾†æºï¼šç¶²è·¯å…¬é–‹è³‡è¨Šå½™æ•´</p>
        <div class="disclaimer">
            ã€å…è²¬è²æ˜ã€‘<br>
            æœ¬ç¶²ç«™ç‚ºå€‹äººå½™æ•´ä¹‹å…¬é–‹è³‡è¨Šå¹³å°ï¼Œæ—¨åœ¨æä¾›ä¾¿åˆ©çš„æŸ¥è©¢æœå‹™ã€‚<br>
            æ‰€æœ‰æ´»å‹•å…§å®¹ã€æ™‚é–“ã€åœ°é»åŠè²»ç”¨ç­‰è©³æƒ…ï¼Œè«‹ä»¥å„ä¸»è¾¦å–®ä½å®˜æ–¹æœ€æ–°å…¬å‘Šç‚ºæº–ã€‚<br>
            è‹¥å› è³‡è¨Šæ›´å‹•æˆ–èª¤æ¤å°è‡´ä»»ä½•æå¤±ï¼Œæœ¬ç«™æ•ä¸è² è²¬ã€‚
        </div>
    </footer>

    <script>
        // ==========================================
        // 1. è¨­å®šè³‡æ–™åº«é€£çµ (Google Sheet CSV)
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ-St7MX96Iy6KCTUt15jzZEm2H8WVF8pK4iJj4qL7j2oTCxCKopoak0xgHq5RzjKNEmO7JgsXF389i/pub?output=csv";
        
        // 2. è¨­å®šå›å ±è¡¨å–®é€£çµ (è«‹æ›¿æ›æˆæ‚¨çš„ Google Form ç¶²å€)
        const FEEDBACK_URL = "https://docs.google.com/forms/d/e/1FAIpQLSeYLGHSuV3Cv-whrW6CEZi9IQbi7qiyEJ_G4ulb4uBLE12feg/viewform?usp=header"; // <--- è«‹åœ¨æ­¤è²¼ä¸Šæ‚¨çš„è¡¨å–®ç¶²å€
        // ==========================================

        document.getElementById('feedback-btn').href = FEEDBACK_URL;

        let allEvents = [];

        function init() {
            Papa.parse(CSV_URL, {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    allEvents = results.data;
                    initFilters(allEvents);
                    renderEvents(allEvents);
                },
                error: function(err) {
                    console.error("Error:", err);
                    document.getElementById('loading').innerText = "è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯è¨­å®šã€‚";
                }
            });
        }

        function calculateStatus(dateStr) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dates = dateStr.match(/(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/g);
            
            if (!dates) return { code: 'unknown', text: 'æ—¥æœŸæœªå®š', class: 'bg-ended' };

            const startDate = new Date(dates[0]);
            let endDate = dates.length > 1 ? new Date(dates[1]) : new Date(dates[0]);

            const diffStart = Math.ceil((startDate - today) / (1000 * 60 * 60 * 24));
            const diffEnd = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));

            if (diffEnd < 0) return { code: 'ended', text: 'å·²çµæŸ', class: 'bg-ended' };
            if (diffStart === 0) return { code: 'today', text: 'å°±æ˜¯ä»Šå¤©ï¼', class: 'bg-today' };
            if (diffStart > 0) return { code: 'coming', text: `å€’æ•¸ ${diffStart} å¤©`, class: 'bg-coming' };
            return { code: 'active', text: `é€²è¡Œä¸­ (å‰© ${diffEnd} å¤©)`, class: 'bg-active' };
        }

        function initFilters(data) {
            const monthSet = new Set();
            const catSet = new Set();
            const monthSelect = document.getElementById('month-filter');
            const catSelect = document.getElementById('cat-filter');
            const statusSelect = document.getElementById('status-filter');

            data.forEach(item => {
                let dateStr = item['æ´»å‹•æ—¥æœŸ'] || '';
                let match = dateStr.match(/(\d{4})[\/\-](\d{1,2})/);
                if (match) monthSet.add(`${match[1]}å¹´${match[2]}æœˆ`);
                let cat = item['æ´»å‹•é¡åˆ¥'] || item['é¡åˆ¥'];
                if (cat) catSet.add(cat.trim());
            });

            Array.from(monthSet).sort((a,b)=>a.localeCompare(b,'zh-Hant-TW',{numeric:true})).forEach(m => monthSelect.add(new Option(m, m)));
            Array.from(catSet).forEach(c => catSelect.add(new Option(c, c)));

            const handleFilter = () => {
                const mVal = monthSelect.value;
                const cVal = catSelect.value;
                const sVal = statusSelect.value;

                const filtered = data.filter(item => {
                    const status = calculateStatus(item['æ´»å‹•æ—¥æœŸ'] || '');
                    if (sVal === 'active' && status.code === 'ended') return false;
                    
                    let monthMatch = true;
                    if (mVal !== 'all') {
                        let [y, m] = mVal.replace('å¹´', '/').replace('æœˆ', '').split('/');
                        let dateStr = item['æ´»å‹•æ—¥æœŸ'] || '';
                        monthMatch = dateStr.includes(`${y}/${m}`) || dateStr.includes(`${y}-${m}`) || dateStr.includes(`${y}/${m.padStart(2,'0')}`);
                    }

                    let catMatch = cVal === 'all' ? true : (item['æ´»å‹•é¡åˆ¥'] || '').includes(cVal);
                    return monthMatch && catMatch;
                });
                renderEvents(filtered);
            };

            monthSelect.addEventListener('change', handleFilter);
            catSelect.addEventListener('change', handleFilter);
            statusSelect.addEventListener('change', handleFilter);
            handleFilter(); 
        }

        function renderEvents(data) {
            const container = document.getElementById('event-container');
            const loading = document.getElementById('loading');
            const updateTime = document.getElementById('update-time');
            
            loading.style.display = 'none';
            container.innerHTML = '';

            const now = new Date();
            updateTime.innerText = `æœ€å¾Œæ›´æ–°ï¼š${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;

            if (data.length === 0) {
                container.innerHTML = '<div style="text-align:center; width:100%; padding:2rem; color:#888;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æ´»å‹•ã€‚</div>';
                return;
            }

            data.sort((a, b) => (a['æ´»å‹•æ—¥æœŸ'] || '').localeCompare(b['æ´»å‹•æ—¥æœŸ'] || ''));

            data.forEach(item => {
                const name = item['æ´»å‹•åç¨±'];
                if (!name) return;

                const dateStr = item['æ´»å‹•æ—¥æœŸ'] || '';
                const status = calculateStatus(dateStr);
                const place = item['æ´»å‹•åœ°é»'] || item['åœ°é»'] || 'è©³è¦‹å®˜ç¶²';
                const org = item['ä¸»è¾¦å–®ä½'] || '';
                const cat = item['æ´»å‹•é¡åˆ¥'] || 'ä¸€èˆ¬æ´»å‹•';
                let link = (item['é€£çµ'] || '').trim();

                let catClass = '';
                if (cat.includes('æ…¶å…¸') || cat.includes('æˆ¶å¤–')) catClass = 'cat-celebration';
                else if (cat.includes('è—æ–‡') || cat.includes('å±•')) catClass = 'cat-art';
                else if (cat.includes('è¬›åº§')) catClass = 'cat-lecture';

                let placeHtml = place;
                if (place && place !== 'è©³è¦‹å®˜ç¶²' && place !== 'åœ°é»å¾…å®š') {
                    placeHtml = `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place)}" target="_blank" class="map-link" title="é»æ“Šå°èˆª">${place}</a>`;
                }

                let linkHtml = link.startsWith('http') 
                    ? `<a href="${link}" target="_blank" class="btn-link">æŸ¥çœ‹æ´»å‹•è©³æƒ…</a>`
                    : `<div class="btn-link disabled">ç„¡é€£çµè³‡è¨Š</div>`;

                const cardClass = status.code === 'ended' ? 'event-card ended' : 'event-card';

                const card = document.createElement('div');
                card.className = cardClass;
                card.innerHTML = `
                    <div class="status-badge ${status.class}">${status.text}</div>
                    <span class="category-tag ${catClass}">${cat}</span>
                    <div class="event-date">
                        <svg class="info-icon" style="fill:var(--accent-color)" viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z"/></svg>
                        ${dateStr}
                    </div>
                    <h3 class="event-title">${name}</h3>
                    <div class="info-row">
                        <svg class="info-icon" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                        <span>${placeHtml}</span>
                    </div>
                    <div class="info-row">
                        <svg class="info-icon" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                        <span>${org}</span>
                    </div>
                    ${linkHtml}
                `;
                container.appendChild(card);
            });
        }

        init();
    </script>
</body>
</html>
