<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>竹北市近期活動一覽表</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #27ae60;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #333;
            --gray-text: #666;
        }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 0; line-height: 1.6; }
        header { background: linear-gradient(135deg, var(--primary-color), #34495e); color: white; padding: 2rem 1rem; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        header h1 { margin: 0; font-size: 1.8rem; letter-spacing: 1px; }
        header p { margin-top: 10px; opacity: 0.9; font-size: 0.95rem; }
        .container { max-width: 1000px; margin: 2rem auto; padding: 0 15px; }
        #loading { text-align: center; padding: 2rem; font-size: 1.2rem; color: var(--gray-text); }
        .event-list { display: grid; gap: 1.5rem; grid-template-columns: 1fr; }
        @media (min-width: 768px) { .event-list { grid-template-columns: repeat(auto-fill, minmax(450px, 1fr)); } }
        .event-card { background: var(--card-bg); border-radius: 10px; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s; border-left: 5px solid var(--accent-color); }
        .event-card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .event-date { display: inline-block; background-color: #e8f5e9; color: #1b5e20; padding: 4px 10px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; margin-bottom: 10px; }
        .event-title { font-size: 1.25rem; font-weight: 700; margin: 0 0 10px 0; color: var(--primary-color); }
        .event-info { font-size: 0.95rem; color: var(--gray-text); margin-bottom: 5px; display: flex; align-items: center; }
        .event-info svg { width: 16px; height: 16px; margin-right: 8px; fill: var(--gray-text); }
        .btn-link { display: block; width: 100%; text-align: center; margin-top: 15px; padding: 10px 0; background-color: var(--primary-color); color: white; text-decoration: none; border-radius: 6px; font-weight: 500; transition: background 0.3s; }
        .btn-link:hover { background-color: #34495e; }
        .btn-link.disabled { background-color: #bdc3c7; cursor: not-allowed; pointer-events: none; opacity: 0.6; }
        footer { text-align: center; padding: 2rem; font-size: 0.8rem; color: #aaa; margin-top: 3rem; border-top: 1px solid #eee; }
        .controls { text-align: right; color: #666; font-size: 0.9rem; margin-bottom: 1rem; }
    </style>
</head>
<body>
    <header>
        <h1>竹北市近期活動快訊</h1>
        <p>彙整竹北最新藝文、親子與社區活動資訊</p>
    </header>
    <div class="container">
        <div class="controls" id="update-time">資料載入中...</div>
        <div id="loading">正在連線至 Google 資料庫...</div>
        <div class="event-list" id="event-container"></div>
    </div>
    <footer>
        <p>資料來源：網路公開資訊彙整 / 自動更新系統</p>
    </footer>

    <script>
        // 這是您提供的 Google Sheet 發布連結 (CSV 格式)
        // 請確認您的試算表已經執行「檔案 > 共用 > 發布到網路 > 選擇 CSV」
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ-St7MX96Iy6KCTUt15jzZEm2H8WVF8pK4iJj4qL7j2oTCxCKopoak0xgHq5RzjKNEmO7JgsXF389i/pub?output=csv";

        function init() {
            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    renderEvents(results.data);
                },
                error: function(err) {
                    console.error("Error:", err);
                    document.getElementById('loading').innerHTML = "讀取失敗。<br>請確認 Google 試算表是否已正確「發布到網路」。";
                }
            });
        }

        function renderEvents(data) {
            const container = document.getElementById('event-container');
            const loading = document.getElementById('loading');
            const updateTime = document.getElementById('update-time');
            
            loading.style.display = 'none';
            const now = new Date();
            updateTime.innerText = `最後更新查閱：${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;

            data.forEach(item => {
                // 1. 智慧搜尋欄位：不管欄位叫什麼，只要包含關鍵字就抓取
                // 例如：欄位叫 "連結(官方)" 或 "活動連結" 都能抓到
                let nameKey = Object.keys(item).find(k => k.includes('名稱')) || '活動名稱';
                
                // 若找不到活動名稱，跳過此筆
                if (!item[nameKey] || item[nameKey].trim() === '') return;

                let dateKey = Object.keys(item).find(k => k.includes('日期')) || '活動日期';
                let placeKey = Object.keys(item).find(k => k.includes('地點') || k.includes('場地')) || '活動地點';
                let orgKey = Object.keys(item).find(k => k.includes('主辦')) || '主辦單位';
                
                // 特別處理連結欄位，搜尋包含 "連結"、"網址"、"Link" 或 "URL" 的欄位
                let linkKey = Object.keys(item).find(k => k.includes('連結') || k.includes('網址') || k.includes('Link') || k.includes('url'));

                const date = item[dateKey] || '未定';
                const name = item[nameKey];
                const place = item[placeKey] || '地點待定';
                const org = item[orgKey] || '相關單位';
                
                // 2. 連結處理邏輯修正
                let rawLink = '';
                if (linkKey && item[linkKey]) {
                    rawLink = item[linkKey].trim(); // 去除前後空白
                }

                let linkBtn = '';
                // 只要是 http 開頭就視為有效連結
                if (rawLink.toLowerCase().startsWith('http')) {
                    linkBtn = `<a href="${rawLink}" target="_blank" class="btn-link">查看官方詳情</a>`;
                } else {
                    linkBtn = `<span class="btn-link disabled">暫無連結</span>`;
                }

                const card = document.createElement('div');
                card.className = 'event-card';
                card.innerHTML = `
                    <div class="event-date">${date}</div>
                    <h3 class="event-title">${name}</h3>
                    <div class="event-info">
                        <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                        ${place}
                    </div>
                    <div class="event-info">
                        <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                        ${org}
                    </div>
                    ${linkBtn}
                `;
                container.appendChild(card);
            });

            if (container.children.length === 0) {
                container.innerHTML = '<p style="text-align:center; width:100%;">目前沒有活動資料，或試算表格式有誤。</p>';
            }
        }

        init();
    </script>
</body>
</html>
